<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title id="pageTitle">MP3 Плеер</title>
  <link id="favicon" rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'/%3E" type="image/svg+xml">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      color-scheme: dark;
      --btn: 40px; /* базовый размер кнопок */
      --gap: 8px;  /* зазор между кнопками */
    }
    body { margin: 0; background:#111; color:#eee; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    .wrap { margin: 6vh auto; padding: 16px; }

    /* Карточка авто-ширины по содержимому, но не больше окна */
    .card {
      background:#1b1b1b; border:1px solid #2a2a2a; border-radius: 14px; padding: 18px;
      width: fit-content; max-width: 95vw; margin: 0 auto;
    }
    @media (max-width: 820px) { .card { width: 100%; max-width: 100%; } }

    /* Грид: правая колонка по содержимому */
    .grid {
      display: grid;
      grid-template-columns:
        clamp(200px, 32vw, 420px)
        clamp(56px, 6vw, 80px)
        max-content;
      grid-template-areas: "left mid right";
      gap: 16px;
      align-items: center;
    }
    .left  { grid-area: left; }
    .mid   { grid-area: mid; }
    .right { grid-area: right; min-width: 0; width: max-content; }
    @media (max-width: 820px) {
      .grid { grid-template-columns: 1fr; grid-template-areas: "left" "mid" "right"; }
      .right { width: 100%; }
    }

    /* Обложка и метаданные */
    .cover-big { width: 100%; aspect-ratio: 1 / 1; border-radius: 12px; object-fit: cover; background:#222; box-shadow: 0 8px 24px rgba(0,0,0,.35); }
    .meta-box { margin-top: 10px; min-width: 0; }
    .title-clip { position: relative; overflow: hidden; white-space: nowrap; width: 100%; }
    .title-line { display: inline-block; }
    .title-marquee { display: inline-block; padding-right: 2rem; }
    .title-clip.scroll .title-track { display: inline-block; white-space: nowrap; will-change: transform; animation: marquee 12s linear infinite; }
    @keyframes marquee { 0%{transform:translateX(0);} 100%{transform:translateX(-50%);} }
    .title { font-size: 20px; margin: 0 0 6px; display:inline; }
    .meta  { color:#aaa; font-size: 14px; margin: 0 0 2px; }

    /* Вертикальная полоса прогресса */
    .vseek-wrap { display:flex; flex-direction:column; align-items:center; gap:10px; justify-content:center; min-height:220px; }
    .vtime { font-size:12px; color:#8a8a8a; }
    input[type="range"].vseek {
      writing-mode: vertical-lr; direction: rtl; appearance: slider-vertical; -webkit-appearance: slider-vertical;
      width: 16px; height: 220px; background: linear-gradient(to top, #f50 0%, #f50 var(--prog, 0%), #3a3a3a var(--prog, 0%), #3a3a3a 100%);
      border-radius: 10px; outline: none;
    }
    input[type="range"].vseek::-webkit-slider-thumb { -webkit-appearance:none; appearance:none; width:16px; height:16px; background:#fff; border-radius:50%; border:none; box-shadow:0 0 0 2px #111, 0 2px 6px rgba(0,0,0,.4); }
    input[type="range"].vseek::-moz-range-thumb { width:16px; height:16px; background:#fff; border:none; border-radius:50%; box-shadow:0 0 0 2px #111, 0 2px 6px rgba(0,0,0,.4); }
    input[type="range"].vseek::-moz-range-track { background:transparent; border:none; }

    /* Правая колонка: ряд ориентирован ровно под 2 кнопки */
    .controls { display:grid; grid-template-rows: auto auto; row-gap: 10px; align-items:start; min-width:0; }
    .row {
      display: inline-grid;
      grid-auto-flow: column;
      grid-template-columns: var(--btn) var(--btn); /* учитываются только play и mute */
      column-gap: var(--gap);
      align-items: center;
      height: calc(var(--btn) + 4px);
      width: calc(var(--btn) * 2 + var(--gap));
      min-width: auto; padding: 0; margin: 0; position: relative;
    }

    .icon-btn {
      width: var(--btn); height: var(--btn);
      display: inline-grid; place-items: center;
      background:#2c2c2c; color:#eee; border:1px solid #3a3a3a; border-radius: 10px;
      cursor:pointer; transition: background .15s ease;
    }
    .icon-btn:hover { background:#353535; }
    .icon { font-size: 16px; line-height: 1; pointer-events: none; }

    /* Попап громкости: не влияет на размеры ряда */
    .volume-wrap { position: static; display: contents; }
    .vol-popup {
      position: absolute; left: calc(var(--btn) + var(--gap) + var(--btn)/2);
      transform: translateX(-50%);
      bottom: calc(var(--btn) + 8px);
      background: #222; border: 1px solid #333; border-radius: 10px; padding: 8px 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,.35); display: none; z-index: 10;
    }
    #mute:hover + .vol-popup, .vol-popup:hover, .vol-popup:focus-within { display: block; }

    input[type="range"].vvol {
      writing-mode: vertical-lr; direction: rtl; appearance: slider-vertical; -webkit-appearance: slider-vertical;
      width: 16px; height: 120px; background: linear-gradient(to top, #8ab4f8 0%, #8ab4f8 var(--vol, 100%), #3a3a3a var(--vol, 100%), #3a3a3a 100%);
      border-radius: 10px; outline:none;
    }
    input[type="range"].vvol::-webkit-slider-thumb { -webkit-appearance:none; appearance:none; width:16px; height:16px; background:#fff; border-radius:50%; border:none; box-shadow:0 0 0 2px #111, 0 2px 6px rgba(0,0,0,.4); }
    input[type="range"].vvol::-moz-range-thumb { width:16px; height:16px; background:#fff; border:none; border-radius:50%; box-shadow:0 0 0 2px #111, 0 2px 6px rgba(0,0,0,.4); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="grid">
        <div class="left">
          <img id="cover" class="cover-big" alt="Обложка" />
          <div class="meta-box">
            <div class="title-clip" id="titleClip" aria-live="polite">
              <div class="title-track">
                <span class="title title-line" id="title">Загружается…</span>
                <span class="title-marquee title-line" id="titleDupe" aria-hidden="true" style="display:none;"></span>
              </div>
            </div>
            <p class="meta" id="artist">—</p>
            <p class="meta" id="album">—</p>
          </div>
        </div>

        <div class="mid vseek-wrap">
          <span class="vtime" id="timeTop">0:00</span>
          <input id="seek" class="vseek" type="range" min="0" max="100" value="0" step="0.1" orient="vertical" />
          <span class="vtime" id="timeBottom">0:00</span>
        </div>

        <div class="right controls">
          <div class="row">
            <button id="playPause" class="icon-btn" aria-label="Воспроизвести/Пауза" aria-pressed="false">
              <i id="playIcon" class="fa-solid fa-play icon" aria-hidden="true" style="display:inline-block;"></i>
              <i id="pauseIcon" class="fa-solid fa-pause icon" style="display:none;" aria-hidden="true"></i>
            </button>

            <button id="mute" class="icon-btn" aria-label="Звук">
              <i id="volIcon" class="fa-solid fa-volume-high icon" aria-hidden="true"></i>
            </button>

            <div class="vol-popup">
              <input id="volume" class="vvol" type="range" min="0" max="1" step="0.01" value="1" style="--vol:100%;">
            </div>
          </div>

          <audio id="player" src="/music/last.mp3" preload="metadata" loop></audio>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { parseBlob } from 'https://cdn.jsdelivr.net/npm/music-metadata@11/+esm';

    const src = '/music/last.mp3';
    const pageTitle = document.getElementById('pageTitle');
    const favicon = document.getElementById('favicon');

    const player = document.getElementById('player');
    const playPause = document.getElementById('playPause');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    const seek = document.getElementById('seek');
    const timeTop = document.getElementById('timeTop');
    const timeBottom = document.getElementById('timeBottom');
    const volume = document.getElementById('volume');
    const muteBtn = document.getElementById('mute');
    const volIcon = document.getElementById('volIcon');

    const elTitle = document.getElementById('title');
    const elTitleDupe = document.getElementById('titleDupe');
    const elTitleClip = document.getElementById('titleClip');
    const elArtist = document.getElementById('artist');
    const elAlbum = document.getElementById('album');
    const elCover = document.getElementById('cover');

    function formatTime(sec){ if(!isFinite(sec)) return '0:00'; const m=Math.floor(sec/60); const s=Math.floor(sec%60).toString().padStart(2,'0'); return `${m}:${s}`; }
    function setSeekProgress(cur,dur){ const p=dur>0?(cur/dur)*100:0; seek.value=p; seek.style.setProperty('--prog',p+'%'); }
    function updateTime(){ const cur=player.currentTime||0; const dur=player.duration||0; timeTop.textContent=formatTime(cur); timeBottom.textContent=formatTime(dur); setSeekProgress(cur,dur); }

    function updatePlayUI(){ const playing=!player.paused; playIcon.style.display=playing?'none':'inline-block'; pauseIcon.style.display=playing?'inline-block':'none'; playPause.setAttribute('aria-pressed',String(playing)); }
    playPause.addEventListener('click',()=>{ if(player.paused) player.play(); else player.pause(); });
    player.addEventListener('play',updatePlayUI);
    player.addEventListener('pause',updatePlayUI);

    player.addEventListener('timeupdate',updateTime);
    player.addEventListener('loadedmetadata',updateTime);
    seek.addEventListener('input',()=>{ const dur=player.duration||0; if(dur>0) player.currentTime=(seek.value/100)*dur; });

    function updateVolIcon(){ volIcon.className=(player.muted||player.volume===0)?'fa-solid fa-volume-xmark icon':'fa-solid fa-volume-high icon'; const pct=Math.round(player.volume*100); volume?.style.setProperty('--vol',pct+'%'); }
    volume?.addEventListener('input',()=>{ player.volume=Number(volume.value); if(player.volume>0) player.muted=false; updateVolIcon(); });
    muteBtn.addEventListener('click',()=>{ player.muted=!player.muted; updateVolIcon(); });

    function setTitleAndScroll(text){
      const t=text||'Без названия';
      elTitle.textContent=t;
      elTitleDupe.textContent='   '+t;
      pageTitle.textContent=t;
      requestAnimationFrame(()=>{ const needs=elTitle.scrollWidth>elTitleClip.clientWidth; elTitleClip.classList.toggle('scroll',needs); elTitleDupe.style.display=needs?'inline-block':'none'; });
    }

    async function setFaviconFromBlob(blob, mime){
      try{
        const url=URL.createObjectURL(new Blob([blob],{type:mime|| 'image/png'}));
        favicon.href=url; favicon.type=mime||'image/png';
      }catch{}
    }

    async function readMeta(){
      try{
        const res=await fetch(src,{credentials:'same-origin'}); if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const mp3=await res.blob();
        const { common } = await parseBlob(mp3);

        setTitleAndScroll(common.title);
        elArtist.textContent=common.artist||'Неизвестный исполнитель';
        elAlbum.textContent=common.album||'—';

        if(common.picture && common.picture[0]){
          const pic=common.picture[0];
          const imgUrl=URL.createObjectURL(new Blob([pic.data],{type:pic.format||'image/jpeg'}));
          elCover.src=imgUrl;
          await setFaviconFromBlob(pic.data, pic.format);
        }else{
          elCover.removeAttribute('src');
        }
      }catch(e){
        setTitleAndScroll('Не удалось прочитать теги');
        elArtist.textContent='—'; elAlbum.textContent='—'; elCover.removeAttribute('src');
        console.error(e);
      }
    }
    readMeta();

    // Сохранение состояния в localStorage
    const STORAGE_PREFIX = 'mp3player:';
    const trackKey = (k) => `${STORAGE_PREFIX}${src}:${k}`;
    let saveTimer = null;
    function saveState() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        try {
          const state = {
            t: Math.floor(player.currentTime || 0),
            playing: !player.paused,
            vol: Number(player.volume ?? 1),
            muted: !!player.muted
          };
          localStorage.setItem(trackKey('state'), JSON.stringify(state));
        } catch {}
      }, 150);
    }
    function restoreState() {
      try {
        const raw = localStorage.getItem(trackKey('state'));
        if (!raw) return;
        const s = JSON.parse(raw);
        if (typeof s.vol === 'number') player.volume = s.vol;
        if (typeof s.muted === 'boolean') player.muted = s.muted;
        updateVolIcon?.();
        const restoreTime = Number(s.t) || 0;
        const wantPlay = !!s.playing;
        function applyTime() {
          const dur = player.duration || 0;
          if (dur > 0) {
            player.currentTime = Math.min(restoreTime, dur - 0.25);
            updateTime?.();
            if (wantPlay) player.play().catch(()=>{});
            player.removeEventListener('loadedmetadata', applyTime);
          }
        }
        player.addEventListener('loadedmetadata', applyTime);
      } catch {}
    }
    ['timeupdate','play','pause','volumechange','seeking','seeked'].forEach(ev => player.addEventListener(ev, saveState));
    window.addEventListener('beforeunload', saveState);
    restoreState();

    async function tryAutoplay(){ const pv=player.volume; try{ player.volume=0; await player.play(); player.volume=Number(document.getElementById('volume')?.value ?? 1);}catch{ player.volume=pv;} updatePlayUI(); updateVolIcon(); }
    player.addEventListener('loadedmetadata',tryAutoplay);
  </script>
</body>
</html>
